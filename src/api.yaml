swagger: "2.0"
host: otomi-stack-api
securityDefinitions:
  groupAuthz:
    type: "apiKey"
    name: "Auth-Group"
    in: "header"

security:
  - groupAuthz: []

basePath: /v1
info:
  title: The otomi-stack API
  version: "0.1.0"
paths:
  /readiness:
    get:
      security: []
      description: Check readiness
      parameters: []
      responses:
        200:
          description: Service is ready
  /teams:
    get:
      description: Get teams collection
      parameters: []
      responses:
        200:
          description: Successfully obtained teams collection
          schema:
            $ref: "#/definitions/Teams"
    post:
      description: Create a team
      parameters:
        - in: "body"
          name: "body"
          description: "Team object that needs to be added to the collection"
          required: true
          schema:
            $ref: "#/definitions/Team"
      responses:
        201:
          description: Successfully obtained teams collection
          schema:
            $ref: "#/definitions/Team"
        400:
          description: Bad Request
          schema:
            $ref: "#/definitions/OpenApiValidationError"
        409:
          description: Team already exists
          schema:
            $ref: "#/definitions/OtomiStackError"
  /teams/{teamId}:
    get:
      description: Get a specific team
      parameters:
        - name: "teamId"
          in: "path"
          description: "ID of team to return"
          required: true
          type: "string"
      responses:
        200:
          description: Successfully obtained team
          schema:
            $ref: "#/definitions/Team"
        400:
          description: Bad Request
          schema:
            $ref: "#/definitions/OpenApiValidationError"
        404:
          description: Team does not exists
          schema:
            $ref: "#/definitions/OtomiStackError"
    put:
      description: Edit a team
      parameters:
        - name: "teamId"
          in: "path"
          description: "ID of team to return"
          required: true
          type: "string"
        - in: "body"
          name: "body"
          description: "Team object that contains updated values"
          required: true
          schema:
            $ref: "#/definitions/Team"
      responses:
        200:
          description: Successfully edited team
          schema:
            $ref: "#/definitions/Team"
        400:
          description: Bad Request
          schema:
            $ref: "#/definitions/OpenApiValidationError"
        404:
          description: Team does not exists
          schema:
            $ref: "#/definitions/OtomiStackError"
    delete:
      description: Delete team
      parameters:
        - name: "teamId"
          in: "path"
          description: "ID of team to delete"
          required: true
          type: "string"
      responses:
        200:
          description: Successfully deleted a team
        400:
          description: Bad Request
          schema:
            $ref: "#/definitions/OpenApiValidationError"
        404:
          description: Team does not exists
          schema:
            $ref: "#/definitions/OtomiStackError"
  /teams/{teamId}/services:
    get:
      description: Get services from a given team
      parameters:
        - name: "teamId"
          in: "path"
          description: "ID of team"
          required: true
          type: "string"
      responses:
        200:
          description: Successfully obtained services
          schema:
            $ref: "#/definitions/Services"
        400:
          description: Bad Request
          schema:
            $ref: "#/definitions/OpenApiValidationError"
    post:
      description: Create a service
      parameters:
        - name: "teamId"
          in: "path"
          description: "ID of team"
          required: true
          type: "string"
        - in: "body"
          name: "body"
          description: "Service object"
          required: true
          schema:
            $ref: "#/definitions/Service"
      responses:
        201:
          description: Successfully obtained teams collection
          schema:
            $ref: "#/definitions/Team"
        400:
          description: Bad Request
          schema:
            $ref: "#/definitions/OpenApiValidationError"
        409:
          description: Team already exists
          schema:
            $ref: "#/definitions/OtomiStackError"
  /teams/{teamId}/services/{serviceId}:
    get:
      description: Get a service from a given team
      parameters:
        - name: "teamId"
          in: "path"
          description: "ID of team to return"
          required: true
          type: "string"
        - name: "serviceId"
          in: "path"
          description: "ID of the service"
          required: true
          type: "string"
      responses:
        200:
          description: Successfully obtained service
          schema:
            $ref: "#/definitions/Team"
        400:
          description: Bad Request
          schema:
            $ref: "#/definitions/OpenApiValidationError"
        404:
          description: Service does not exists
          schema:
            $ref: "#/definitions/OtomiStackError"
    put:
      description: Edit a service from a given team
      parameters:
        - name: "teamId"
          in: "path"
          description: "ID of team to return"
          required: true
          type: "string"
        - name: "serviceId"
          in: "path"
          description: "ID of the service"
          required: true
          type: "string"
        - in: "body"
          name: "body"
          description: "Service object that contains updated values"
          required: true
          schema:
            $ref: "#/definitions/Service"
      responses:
        200:
          description: Successfully edited service
          schema:
            $ref: "#/definitions/Team"
        400:
          description: Bad Request
          schema:
            $ref: "#/definitions/OpenApiValidationError"
        404:
          description: Service does not exists
          schema:
            $ref: "#/definitions/OtomiStackError"
    delete:
      description: Delete a service from a given team
      parameters:
        - name: "teamId"
          in: "path"
          description: "ID of team to delete"
          required: true
          type: "string"
        - name: "serviceId"
          in: "path"
          description: "ID of the service"
          required: true
          type: "string"
      responses:
        200:
          description: Successfully deleted a service
        400:
          description: Bad Request
          schema:
            $ref: "#/definitions/OpenApiValidationError"
        404:
          description: Service does not exists
          schema:
            $ref: "#/definitions/OtomiStackError"
  /teams/{teamId}/deployments:
    post:
      description: Trigger a deployment
      parameters:
        - name: "teamId"
          in: "path"
          description: "ID of team to delete"
          required: true
          type: "string"
      responses:
        202:
          description: Deployment has been triggered
          schema:
            $ref: "#/definitions/Deployment"
        409:
          description: There is ongoing deployment
          schema:
            $ref: "#/definitions/Deployment"
  
  /teams/{teamId}/deployments/{deploymentId}:
    get:
      description: Get deployment
      parameters:
        - name: "teamId"
          in: "path"
          description: "ID of team to delete"
          required: true
          type: "string"
        - name: "deploymentId"
          in: "path"
          description: "ID of team to return"
          required: true
          type: "integer"
      responses:
        200:
          description: Deployment has been triggered
          schema:
            $ref: "#/definitions/Deployment"

  /apiDocs:
    get:
      security: []
      description: Get OpenApi document
      responses:
        200:
          description: The requested apiDoc.
          schema:
            type: object
        default:
          description: The requested apiDoc.

definitions:
  Deployment:
    properties:
      id:
        type: integer
      status:
        type: string
        description: Deployment status
        enum: [in-progress, completed, failed]
  Team:
    properties:
      name:
        type: string
        pattern: '^[a-z0-9]([-a-z0-9]*[a-z0-9])?$'
      password:
        type: string
      oidc:
        $ref: "#/definitions/TeamOidc"
    required:
      - name
      - password
      - oidc

  TeamOidc:
    properties:
      clientID:
        type: string
      clientSecret:
        type: string
  Teams:
    properties:
      teams:
        type: array
        items:
          $ref: "#/definitions/Team"
  Services:
    properties:
      services:
        type: array
        items:
          $ref: "#/definitions/Service"
  Service:
    properties:
      name:
        type: string
        description: Service name visible as subdomain
        pattern: '^[a-z0-9]([-a-z0-9]*[a-z0-9])?$'
      domain:
        type: string
        description: A custom domain
        pattern: '^(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9])$'
      svc:
        type: string
        readOnly: true
      image:
        type: object
        properties:
          registry:
            type: string
            pattern: '^(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9])$'
            example: 'docker.io'
          repository:
            type: string
            pattern: '^[a-z0-9]+(?:[._-]{1,2}[a-z0-9]+)*$'
          tag:
            type: string
    required:
      - name

  OpenApiValidationError:
    properties:
      status:
        type: integer
      errors:
        type: array
        items:
          $ref: "#/definitions/ValidationError"

  ValidationError:
    properties:
      path:
        type: "string"
      errorCode:
        type: "string"
      message:
        type: "string"
      location:
        type: "string"
        enum: [body, path]

  OtomiStackError:
    properties:
      message:
        type: "string"
