openapi: 3.0.0
security:
  - groupAuthz: []
info:
  title: The otomi-stack API
  description: Holds the entire schema needed by console to autogenerate forms
  version: PLACEHOLDER
externalDocs:
  description: This is the base url of the external documentation
  url: 'https://otomi.io/'
x-responses:
  BadRequest:
    description: Bad Request
    content: &ref_2
      application/json:
        schema:
          x-acl: &ref_22 []
          properties: &ref_23
            status:
              type: integer
            errors:
              type: array
              items:
                x-acl: []
                properties:
                  path:
                    type: string
                  errorCode:
                    type: string
                  message:
                    type: string
                  location:
                    type: string
                    enum:
                      - body
                      - path
  OtomiStackError:
    description: Resource already exists
    content: &ref_3
      application/json:
        schema:
          x-acl: &ref_0 []
          properties: &ref_1
            message:
              type: string
  NotFound:
    description: Resource does not exist
    content: &ref_4
      application/json:
        schema:
          x-acl: *ref_0
          properties: *ref_1
x-post-responses:
  '400': &ref_10
    description: Bad Request
    content: *ref_2
  '409': &ref_11
    description: Resource already exists
    content: *ref_3
x-get-responses:
  '400': &ref_12
    description: Bad Request
    content: *ref_2
  '404': &ref_13
    description: Resource does not exist
    content: *ref_4
paths:
  /clusters:
    get:
      operationId: getClusters
      description: Get available clusters
      x-aclSchema: Clusters
      responses:
        '200':
          description: Successfully obtained cluster collection
          content:
            application/json:
              schema:
                items: &ref_36
                  x-acl: &ref_34
                    admin:
                      - read-any
                    team:
                      - read-any
                  properties: &ref_35
                    enabled:
                      type: boolean
                      default: true
                    name:
                      type: string
                      description: A cluster name
                      readOnly: true
                    cloud:
                      type: string
                      description: A cloud provider name
                      readOnly: true
                    domain:
                      type: string
                      description: A default cluster DNS zone
                      readOnly: true
                    dnsZones:
                      type: array
                      description: A list of DNS zones that are available to the cluster
                      items:
                        type: string
                      readOnly: true
                      uniqueItems: true
                    hasKnative:
                      description: >-
                        A flag that indicates capability for deploying
                        serverless services by using Knative
                      type: boolean
                      readOnly: true
                    k8sVersion:
                      description: A version of kubernetes that is installed on the cluster
                      type: string
                      readOnly: true
                    otomiVersion:
                      description: A version of kubernetes that is installed on the cluster
                      type: string
                      readOnly: true
                    region:
                      description: A physical location of the cluster
                      type: string
                      readOnly: true
                    clusterId:
                      description: An unique cluster identifier
                      type: string
                      readOnly: true
                type: array
                x-acl: &ref_37
                  admin:
                    - read-any
                  team:
                    - read-any
  /secrets:
    get:
      operationId: getAllSecrets
      description: Get all secrets
      x-aclSchema: Secrets
      responses:
        '200':
          description: Successfully obtained all secrets
          content:
            application/json:
              schema:
                items: &ref_20
                  x-acl: &ref_24
                    admin:
                      - read-any
                      - create-any
                      - update-any
                      - delete-any
                    team:
                      - read
                      - create
                      - update
                      - delete
                  properties: &ref_25
                    id:
                      readOnly: true
                      type: string
                    name:
                      type: string
                      pattern: >-
                        ^[a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*$
                      title: Name
                      description: A secret name
                      example: secret01
                    clusterId:
                      x-acl:
                        admin:
                          - read
                          - create
                        team:
                          - read
                          - create
                      title: Cluster ID
                      type: string
                      description: A kubernetes cluster for the secret
                  required: &ref_26
                    - name
                    - clusterId
                  oneOf: &ref_27
                    - title: Generic
                      properties:
                        type:
                          default: generic
                          enum:
                            - generic
                        entries:
                          type: array
                          items:
                            description: A property name at vaultPath
                            minItems: 1
                            pattern: '^[a-zA-Z0-9_]*$'
                            type: string
                            uniqueItems: true
                      required:
                        - type
                        - entries
                    - title: Docker registry
                      properties:
                        type:
                          default: docker-registry
                          enum:
                            - docker-registry
                          type: string
                        dockerconfig:
                          type: string
                          enum:
                            - .dockerconfig.json
                          default: .dockerconfig.json
                          readOnly: true
                      required:
                        - type
                    - title: TLS
                      properties:
                        type:
                          default: tls
                          enum:
                            - tls
                          type: string
                        crt:
                          type: string
                          default: tls.crt
                          description: >-
                            A Vault property name that contains PEM public key
                            certificate
                        key:
                          type: string
                          default: tls.key
                          description: >-
                            A Vault property name that contains PEM private key
                            certificate
                        ca:
                          type: string
                          title: CA
                          description: >-
                            A Vault property name that contains CA certificate
                            content
                      required:
                        - type
                        - crt
                        - key
                type: array
                x-acl: &ref_21
                  admin:
                    - read-any
                  team:
                    - read-any
        '400':
          description: Bad Request
          content: *ref_2
  /services:
    get:
      operationId: getAllServices
      description: Get services from a given team
      x-aclSchema: Services
      responses:
        '200':
          description: Successfully obtained all services
          content:
            application/json:
              schema:
                items: &ref_15
                  x-externalDocsPath: docs/configuring-services
                  x-acl: &ref_17
                    admin:
                      - delete-any
                      - read-any
                      - create-any
                      - update-any
                    team:
                      - delete
                      - read
                      - create
                      - update
                  properties: &ref_18
                    enabled:
                      type: boolean
                      default: true
                    id:
                      type: string
                      readOnly: true
                    name:
                      title: Name
                      description: >-
                        A lowercase name that starts with a letter and may
                        contain dashes.
                      example: some-service
                      pattern: '^[a-z0-9]([-a-z0-9]*[a-z0-9])?$'
                      type: string
                    port:
                      description: A service port
                      type: integer
                      default: 80
                      minimum: 1
                      maximum: 65535
                    clusterId:
                      title: Cluster ID
                      type: string
                      description: A kubernetes cluster for the service
                      x-acl:
                        admin:
                          - read
                          - create
                        team:
                          - read
                          - create
                    ksvc:
                      title: Type
                      oneOf:
                        - title: Knative service
                          nullable: true
                          properties:
                            serviceType:
                              type: string
                              enum:
                                - ksvc
                              default: ksvc
                            scaleToZero:
                              title: Scale to zero
                              description: >-
                                Scales to zero after 60 seconds and needs
                                approximately 8 seconds to start back up.
                              type: boolean
                              default: false
                            image:
                              title: Container image
                              nullable: true
                              properties:
                                repository:
                                  description: A container image repository.
                                  pattern: '^[a-z0-9]+(?:[/._-]{1,2}[a-z0-9]+)*$'
                                  type: string
                                tag:
                                  type: string
                            secrets:
                              type: array
                              items:
                                properties:
                                  name:
                                    type: string
                                  entries:
                                    title: Entries
                                    type: array
                                    items:
                                      type: string
                                    uniqueItems: true
                                required:
                                  - name
                              required:
                                - repository
                                - tag
                            env:
                              title: Environment variables
                              type: array
                              nullable: true
                              items:
                                properties:
                                  name:
                                    additionalProperties: false
                                    nullable: true
                                    x-patternProperties: &ref_45
                                      '[a-zA-Z_]{1,}[a-zA-Z0-9_]*':
                                        maxLength: 131072
                                        type: string
                                    title: Environment variables
                                  value:
                                    type: string
                                    maxLength: 131072
                                required:
                                  - name
                                  - value
                            resources:
                              title: Pod resources
                              nullable: true
                              properties:
                                requests:
                                  properties:
                                    cpu:
                                      description: >-
                                        Amount of cores, or slice of cpu in
                                        millis.
                                      default: 50m
                                      example: &ref_5
                                        - '1'
                                        - 200m
                                      pattern: '^([0-9]+\.[0-9]{1,2})|([0-9]{2,3}m)?$'
                                      type: string
                                    memory:
                                      description: >-
                                        Amount of memory. Valid units are
                                        E|P|T|G|M|K|Ei|Pi|Ti|Gi|Mi|Ki.
                                      default: 64Mi
                                      example: &ref_6
                                        - 1Mi
                                        - 0.5M
                                      pattern: >-
                                        ^([0-9]+\.)?[0-9]+(E|P|T|G|M|K|Ei|Pi|Ti|Gi|Mi|Ki)?$
                                      type: string
                                  required:
                                    - cpu
                                    - memory
                                limits:
                                  properties:
                                    cpu:
                                      description: >-
                                        Amount of cores, or slice of cpu in
                                        millis.
                                      default: 100m
                                      example: *ref_5
                                      pattern: '^([0-9]+\.[0-9]{1,2})|([0-9]{2,3}m)?$'
                                      type: string
                                    memory:
                                      description: >-
                                        Amount of memory. Valid units are
                                        E|P|T|G|M|K|Ei|Pi|Ti|Gi|Mi|Ki.
                                      default: 128Mi
                                      example: *ref_6
                                      pattern: >-
                                        ^([0-9]+\.)?[0-9]+(E|P|T|G|M|K|Ei|Pi|Ti|Gi|Mi|Ki)?$
                                      type: string
                                  required:
                                    - cpu
                                    - memory
                            annotations:
                              title: Pod annotations
                              additionalProperties: false
                              x-patternProperties: &ref_46
                                ? '^((([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9]){1,253}\/)?([a-z0-9A-Z]+[a-z0-9A-Z-_.]+[a-z0-9A-Z]){1,63}$'
                                : pattern: '^((.){1,253}\/)?(.){1,63}$'
                                  type: string
                            autoCD:
                              title: Continuous delivery
                              description: Deploys new images based on a tagging strategy
                              oneOf:
                                - title: 'Off'
                                  nullable: true
                                  additionalProperties: false
                                - title: Semver versioning
                                  nullable: true
                                  properties:
                                    tagMatcher:
                                      type: string
                                      enum:
                                        - semver
                                      default: semver
                                    semver:
                                      title: Semver version pattern
                                      type: string
                                      example: >-
                                        PATCH only: "~1.1", MINOR and PATCH only
                                        "~1", ALL "*",  ">=1.2.3-0"
                                      description: >-
                                        Use this filter if your image tags
                                        follow semantic versioning rules
                                        (MAJOR.MINOR.PATCH). E.g.: PATCH only:
                                        "~1.1", MINOR and PATCH only "~1", ALL
                                        "*"
                                  required:
                                    - semver
                                - title: Glob pattern matching
                                  properties:
                                    tagMatcher:
                                      type: string
                                      enum:
                                        - glob
                                      default: glob
                                    glob:
                                      title: Glob string pattern
                                      type: string
                                      description: >-
                                        Use this filter if you want to make
                                        glob-style patterns. E.g.: "main-v1.3.*"
                                      example: main-v1.3.*
                                  required:
                                    - glob
                                  additionalProperties: false
                        - title: Existing Knative service
                          properties:
                            serviceType:
                              type: string
                              enum:
                                - ksvcPredeployed
                              default: ksvcPredeployed
                          required:
                            - serviceType
                        - title: Existing Kubernetes service
                          properties:
                            serviceType:
                              type: string
                              enum:
                                - svcPredeployed
                              default: svcPredeployed
                          required:
                            - serviceType
                    ingress:
                      title: Exposure
                      x-acl:
                        team:
                          - read
                      oneOf:
                        - title: Private
                          nullable: true
                          additionalProperties: false
                        - title: Public URL
                          nullable: true
                          properties:
                            useDefaultSubdomain:
                              title: Use team domain (preferred)
                              type: boolean
                              default: true
                              description: >-
                                Use the team domain so that the URL reveals the
                                owner.
                            subdomain:
                              title: Host
                              type: string
                              nullable: true
                              description: A host that is used to set DNS 'A' records
                              pattern: >-
                                ^(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9])$
                            domain:
                              title: DNS Zone
                              description: A managed DNS zone
                              type: string
                            path:
                              title: URL path
                              description: >-
                                The path in the URL that the service should be
                                mapped to (e.g. for microservices on one
                                app/domain.)
                              type: string
                            forwardPath:
                              title: Forward path
                              description: >-
                                Forward the URL path into the service (don't
                                rewrite to /)
                              type: boolean
                            hasSingleSignOn:
                              title: Authenticate with Single Sign On
                              type: boolean
                              default: false
                            hasCert:
                              title: Already has a certificate
                              type: boolean
                              default: false
                              description: If true a certificate should exist already
                            certArn:
                              type: string
                              title: Certificate ARN
                              example: 'arn:aws:acm:eu-central-1:xxx:certificate/xxx'
                            certSelect:
                              type: boolean
                              title: Select existing secret name
                              default: true
                            certName:
                              type: string
                              title: Secret name
                              example: www-example-com
                          required:
                            - domain
                            - subdomain
                    teamId:
                      type: string
                      readOnly: true
                  required: &ref_19
                    - name
                    - clusterId
                    - teamId
                type: array
                x-acl: &ref_16
                  admin:
                    - read-any
                  team:
                    - read-any
        '400':
          description: Bad Request
          content: *ref_2
  /teams:
    get:
      operationId: getTeams
      description: Get teams collection
      x-aclSchema: Teams
      responses:
        '200':
          description: Successfully obtained teams collection
          content:
            application/json:
              schema:
                items: &ref_40
                  x-externalDocsPath: docs/configuring-teams
                  x-acl: &ref_7
                    admin:
                      - delete-any
                      - read-any
                      - create-any
                      - update-any
                    team:
                      - read-any
                      - update
                  properties: &ref_8
                    id:
                      title: ID
                      x-acl:
                        admin:
                          - read
                        team:
                          - read
                      description: >-
                        A lowercase name that starts with a letter and may
                        contain dashes.
                      pattern: '^[a-z0-9]([-a-z0-9]*[a-z0-9])?$'
                      type: string
                    name:
                      title: Name
                      example: otomi
                      x-acl:
                        admin:
                          - create
                          - read
                        team:
                          - read
                      description: >-
                        A lowercase name that starts with a letter and may
                        contain dashes.
                      pattern: '^[a-z0-9]([-a-z0-9]*[a-z0-9])?$'
                      type: string
                    clusters:
                      title: Clusters
                      type: array
                      items:
                        type: string
                      uniqueItems: true
                      minItems: 1
                      x-acl:
                        team:
                          - read
                    oidc:
                      title: OIDC
                      properties:
                        groupMapping:
                          title: Group mapping
                          type: string
                          description: An OIDC group name/id granting access to this team
                    password:
                      type: string
                      writeOnly: true
                    alerts:
                      title: Alerting endpoints
                      properties:
                        receivers:
                          title: Receivers
                          type: array
                          items:
                            type: string
                            enum:
                              - slack
                              - msteams
                              - email
                          uniqueItems: true
                        slack:
                          title: Slack
                          properties:
                            url:
                              title: Web hook
                              type: string
                              description: >-
                                Slack web hook. If none is given the global one
                                is used.
                            channel:
                              title: Channel for non-criticals
                              type: string
                              description: >-
                                Slack channel for non-criticals. If none is
                                given the global one is used, which defaults to
                                'mon-otomi'.
                            channelCrit:
                              title: Channel for criticals
                              type: string
                              description: >-
                                Slack channel for critical alerts. If none is
                                given the global one is used, which defaults to
                                'mon-otomi-crit'.
                        msteams:
                          title: Microsoft Teams
                          properties:
                            lowPrio:
                              title: Low prio webhook
                              type: string
                              description: The low prio web hook
                            highPrio:
                              title: High prio webhook
                              type: string
                              description: The high prio web hook
                        email:
                          title: Email
                          properties:
                            nonCritical:
                              title: Non criticals
                              type: string
                              description: >-
                                One or more email addresses (comma separated)
                                for non-critical events.
                            critical:
                              title: Criticals
                              type: string
                              description: >-
                                Email addresses (comma separated) for critical
                                events.
                    azureMonitor:
                      properties: &ref_28
                        appInsightsApiKey:
                          description: >-
                            An Azure AppInsights client secret (defaults to
                            clientSecret).
                          type: string
                        appInsightsAppId:
                          description: >-
                            An Azure AppInsights client id (defaults to
                            clientId).
                          type: string
                        clientId:
                          description: An Azure client id.
                          type: string
                        clientSecret:
                          description: An Azure client secret.
                          type: string
                        logAnalyticsClientId:
                          description: An Azure client secret (defaults to clientSecret).
                          type: string
                        logAnalyticsClientSecret:
                          description: An Azure client secret (defaults to clientSecret).
                          type: string
                        logAnalyticsTenantId:
                          description: An Azure tenant id (defaults to tenantId).
                          type: string
                        logAnalyticsWorkspace:
                          description: An Azure monitor log analytics workspace.
                          type: string
                  required: &ref_9
                    - name
                    - clusters
                    - password
                type: array
                x-acl: &ref_41
                  admin:
                    - read-any
                  team:
                    - read-any
    post:
      operationId: createTeam
      description: Create a team
      x-aclSchema: Team
      requestBody:
        content:
          application/json:
            schema:
              x-externalDocsPath: docs/configuring-teams
              x-acl: *ref_7
              properties: *ref_8
              required: *ref_9
        description: Team object that needs to be added to the collection
        required: true
      responses:
        '200':
          description: Successfully obtained teams collection
          content:
            application/json:
              schema:
                x-externalDocsPath: docs/configuring-teams
                x-acl: *ref_7
                properties: *ref_8
                required: *ref_9
        '400': *ref_10
        '409': *ref_11
  '/teams/{teamId}':
    parameters:
      - name: teamId
        in: path
        description: ID of team to return
        required: true
        schema: &ref_14
          type: string
    get:
      operationId: getTeam
      description: Get a specific team
      x-aclSchema: Team
      responses:
        '200':
          description: Successfully obtained team
          content:
            application/json:
              schema:
                x-externalDocsPath: docs/configuring-teams
                x-acl: *ref_7
                properties: *ref_8
                required: *ref_9
        '400': *ref_12
        '404': *ref_13
    put:
      operationId: editTeam
      description: Edit a team
      x-aclSchema: Team
      requestBody:
        content:
          application/json:
            schema:
              x-externalDocsPath: docs/configuring-teams
              x-acl: *ref_7
              properties: *ref_8
              required: *ref_9
        description: Team object that contains updated values
        required: true
      responses:
        '200':
          description: Successfully edited team
          content:
            application/json:
              schema:
                x-externalDocsPath: docs/configuring-teams
                x-acl: *ref_7
                properties: *ref_8
                required: *ref_9
        '400': *ref_12
        '404': *ref_13
    delete:
      operationId: deleteTeam
      description: Delete team
      x-aclSchema: Team
      responses:
        '200':
          description: Successfully deleted a team
        '400': *ref_12
        '404': *ref_13
  '/teams/{teamId}/services':
    parameters:
      - name: teamId
        in: path
        description: ID of team to return
        required: true
        schema: *ref_14
    get:
      operationId: getTeamServices
      description: Get services from a given team
      x-aclSchema: Services
      responses:
        '200':
          description: Successfully obtained services
          content:
            application/json:
              schema:
                items: *ref_15
                type: array
                x-acl: *ref_16
        '400':
          description: Bad Request
          content: *ref_2
    post:
      operationId: createService
      description: Create a service
      x-aclSchema: Service
      requestBody:
        content:
          application/json:
            schema:
              x-externalDocsPath: docs/configuring-services
              x-acl: *ref_17
              properties: *ref_18
              required: *ref_19
        description: Service object
        required: true
      responses:
        '200':
          description: Successfully stored service configuration
          content:
            application/json:
              schema:
                x-externalDocsPath: docs/configuring-services
                x-acl: *ref_17
                properties: *ref_18
                required: *ref_19
        '400': *ref_10
        '409': *ref_11
  '/teams/{teamId}/services/{serviceId}':
    parameters:
      - name: teamId
        in: path
        description: ID of team to return
        required: true
        schema: *ref_14
      - name: serviceId
        in: path
        description: ID of the service
        required: true
        schema: &ref_32
          type: string
    get:
      operationId: getService
      description: Get a service from a given team
      x-aclSchema: Service
      responses:
        '200':
          description: Successfully obtained service configuration
          content:
            application/json:
              schema:
                x-externalDocsPath: docs/configuring-services
                x-acl: *ref_17
                properties: *ref_18
                required: *ref_19
        '400': *ref_12
        '404': *ref_13
    put:
      operationId: editService
      description: Edit a service from a given team
      x-aclSchema: Service
      requestBody:
        content:
          application/json:
            schema:
              x-externalDocsPath: docs/configuring-services
              x-acl: *ref_17
              properties: *ref_18
              required: *ref_19
        description: Service object that contains updated values
        required: true
      responses:
        '200':
          description: Successfully edited service
          content:
            application/json:
              schema:
                x-externalDocsPath: docs/configuring-services
                x-acl: *ref_17
                properties: *ref_18
                required: *ref_19
        '400': *ref_12
        '404': *ref_13
    delete:
      operationId: deleteService
      description: Delete a service from a given team
      x-aclSchema: Service
      responses:
        '200':
          description: Successfully deleted a service
        '400': *ref_12
        '404': *ref_13
  '/teams/{teamId}/secrets':
    parameters:
      - name: teamId
        in: path
        description: ID of team to return
        required: true
        schema: *ref_14
    get:
      operationId: getSecrets
      description: Get secrets from a given team
      x-aclSchema: Secrets
      responses:
        '200':
          description: Successfully obtained secrets
          content:
            application/json:
              schema:
                items: *ref_20
                type: array
                x-acl: *ref_21
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                x-acl: *ref_22
                properties: *ref_23
    post:
      operationId: createSecret
      description: Create a team secret
      x-aclSchema: Secret
      parameters:
        - name: teamId
          in: path
          description: ID of team
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              x-acl: *ref_24
              properties: *ref_25
              required: *ref_26
              oneOf: *ref_27
        description: Service object
        required: true
      responses:
        '200':
          description: Successfully stored secret configuration
          content:
            application/json:
              schema:
                x-acl: *ref_24
                properties: *ref_25
                required: *ref_26
                oneOf: *ref_27
        '400': *ref_10
        '409': *ref_11
  '/teams/{teamId}/secrets/{secretId}':
    parameters:
      - name: teamId
        in: path
        description: ID of team to return
        required: true
        schema: *ref_14
      - name: secretId
        in: path
        description: ID of the secret
        required: true
        schema: &ref_33
          type: string
    get:
      operationId: getSecret
      description: Get a secret from a given team
      x-aclSchema: Secret
      responses:
        '200':
          description: Successfully obtained secret configuration
          content:
            application/json:
              schema:
                x-acl: *ref_24
                properties: *ref_25
                required: *ref_26
                oneOf: *ref_27
        '400': *ref_12
        '404': *ref_13
    put:
      operationId: editSecret
      description: Edit a secret from a given team
      x-aclSchema: Secret
      requestBody:
        content:
          application/json:
            schema:
              x-acl: *ref_24
              properties: *ref_25
              required: *ref_26
              oneOf: *ref_27
        description: Secret object that contains updated values
        required: true
      responses:
        '200':
          description: Successfully edited a team secret
          content:
            application/json:
              schema:
                x-acl: *ref_24
                properties: *ref_25
                required: *ref_26
                oneOf: *ref_27
        '400': *ref_12
        '404': *ref_13
    delete:
      operationId: deleteSecret
      description: Delete a secret from a given team
      x-aclSchema: Secret
      responses:
        '200':
          description: Successfully deleted a team secret
        '400': *ref_12
        '404': *ref_13
  /deploy:
    get:
      x-aclSchema: Deployment
      operationId: deploy
      description: Trigger a deployment (only for admin)
      responses:
        '202':
          description: Deployment has been triggered
          content:
            application/json:
              schema:
                type: object
        '409':
          description: Resource already exists
          content: *ref_3
  '/kubecfg/{teamId}':
    parameters:
      - name: teamId
        in: path
        description: ID of team to return
        required: true
        schema: *ref_14
    get:
      operationId: downloadKubecfg
      description: Download a kubecfg for a team
      x-aclSchema: Kubecfg
      responses:
        '200':
          description: Succesfully finished the download
          content:
            application/yaml:
              schema:
                type: object
        '400': *ref_12
        '404': *ref_13
  /session:
    get:
      security: []
      operationId: getSession
      description: Get the session for the current user
      responses:
        '200':
          description: Get the session for the logged in user
          content:
            application/json:
              schema:
                x-acl: &ref_38
                  admin:
                    - read
                  team:
                    - read
                properties: &ref_39
                  clusters:
                    readOnly: true
                    type: array
                    items:
                      type: string
                    uniqueItems: true
                  core:
                    readOnly: true
                  currentClusterId:
                    type: string
                    readOnly: true
                  isDirty:
                    type: boolean
                    readOnly: true
                  namespaces:
                    readOnly: true
                    type: array
                    items:
                      type: string
                  teams:
                    readOnly: true
                    type: array
                    items:
                      x-externalDocsPath: docs/configuring-teams
                      x-acl: *ref_7
                      properties: *ref_8
                      required: *ref_9
                  user:
                    readOnly: true
                    x-acl: &ref_42
                      admin: []
                      team: []
                    properties: &ref_43
                      name:
                        type: string
                        description: A user name
                        readOnly: true
                      email:
                        pattern: >-
                          ^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$
                        type: string
                      isAdmin:
                        type: boolean
                        default: false
                        description: If the user is admin
                        readOnly: true
                      teams:
                        type: array
                        default: []
                        description: A list of teams the user belongs to
                        items:
                          type: string
                        readOnly: true
                        uniqueItems: true
                      roles:
                        type: array
                        default: []
                        description: A list of roles that the user has
                        items:
                          type: string
                        readOnly: true
                        uniqueItems: true
                    required: &ref_44
                      - isAdmin
                      - name
                      - email
                      - teams
                      - roles
        default:
          description: The requested session.
  /apiDocs:
    get:
      operationId: apiDocs
      security: []
      description: Get OpenAPIDoc document
      responses:
        '200':
          description: The requested apiDoc.
          content:
            application/json:
              schema:
                type: object
        default:
          description: The requested apiDoc.
  /settings:
    get:
      operationId: getSettings
      description: Get settings from the `settings.yaml` and `secret.settings.yaml` file.
      x-aclSchema: Settings
      responses:
        '200':
          description: The request is successful.
          content:
            application/json:
              schema:
                x-acl: &ref_30
                  admin:
                    - read-any
                    - update-any
                  team: []
                additionalProperties: false
                properties: &ref_31
                  alerts:
                    properties: &ref_29
                      drone:
                        default: slack
                        enum:
                          - slack
                          - msteams
                        type: string
                      email:
                        additionalProperties: false
                        properties:
                          critical:
                            description: >-
                              One or more email addresses (comma separated) for
                              critical events.
                            pattern: >-
                              ^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$
                            type: string
                          nonCritical:
                            description: >-
                              One or more email addresses (comma separated) for
                              non-critical events.
                            pattern: >-
                              ^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$
                            type: string
                      groupInterval:
                        default: 5m
                        description: >-
                          How long to wait before sending a notification about
                          new alerts that are added to a group of alerts for
                          which an initial notification has already been sent.
                          (Usually ~5m or more.)
                        type: string
                      msteams:
                        additionalProperties: false
                        properties:
                          highPrio:
                            description: The low prio web hook.
                            type: string
                          lowPrio:
                            description: The high prio web hook.
                            type: string
                      receivers:
                        description: Notification receivers.
                        items:
                          enum:
                            - slack
                            - msteams
                            - email
                          type: string
                        type: array
                      repeatInterval:
                        default: 3h
                        description: >-
                          How long to wait before sending a notification again
                          if it has already been sent successfully for an alert.
                          (Usually ~3h or more).
                        type: string
                      slack:
                        additionalProperties: false
                        properties:
                          channel:
                            default: mon-otomi
                            description: The Slack channel for non-critical notifications.
                            type: string
                          channelCrit:
                            default: mon-otomi
                            description: The Slack channel for critical notifications.
                            type: string
                          url:
                            description: A Slack webhook URL.
                            pattern: >-
                              ^(https:\/\/)([\w\-])+\.{1}([a-zA-Z]{2,63})([\/\w-]*)*\/?\??([^#\n\r]*)?#?([^\n\r]*)$
                            type: string
                  azure:
                    description: Azure specific configuration.
                    properties:
                      appgw:
                        properties:
                          isManaged:
                            default: true
                            description: Is this appgw installed as AKS addon?
                            type: boolean
                      diskType:
                        description: An Azure disk type (SKU Type).
                        enum:
                          - Standard_LRS
                          - Standard_GRS
                          - Standard_RAGRS
                          - Standard_ZRS
                          - Premium_LRS
                          - Premium_ZRS
                          - Standard_GZRS
                          - Standard_RAGZRS
                        type: string
                      keyVault:
                        description: >-
                          Azure Key Vault access credentials. Will use
                          azure.tenantId if tenantId is not provided.
                        properties:
                          tenantId:
                            description: An Azure tenant ID.
                            type: string
                          clientId:
                            description: An Azure client ID.
                            type: string
                          clientSecret:
                            description: An Azure client secret.
                            type: string
                        required:
                          - clientId
                          - clientSecret
                      monitor:
                        properties: *ref_28
                      resourceGroup:
                        description: An Azure resource group.
                        type: string
                      subscriptionId:
                        description: An Azure subscription ID.
                        type: string
                      tenantId:
                        description: An Azure tenant ID.
                        type: string
                    required:
                      - diskType
                      - resourceGroup
                      - subscriptionId
                      - tenantId
                  customer:
                    additionalProperties: false
                    properties:
                      name:
                        type: string
                  google:
                    description: Google specific configuration.
                    properties:
                      cloudDnsKey:
                        description: A service account key for managing a DNS zone.
                        type: string
                      kmsAccount:
                        description: A service account key for managing a KMS vault.
                        type: string
                      projectId:
                        description: A Google Cloud project ID for accessing DNS zone.
                        type: string
                    required:
                      - cloudDnsKey
                      - projectId
                  home:
                    properties: *ref_29
                  kms:
                    description: Use Cloud KMS to encrypt and decrypt the master key
                    oneOf:
                      - title: gcpckms
                        properties:
                          gcpckms:
                            properties:
                              project:
                                type: string
                              region:
                                type: string
                              key_ring:
                                type: string
                              kmsAccount:
                                type: string
                            required:
                              - project
                              - region
                              - key_ring
                              - kmsAccount
                        required:
                          - gcpckms
                      - title: awskms
                        properties:
                          awskms:
                            properties:
                              region:
                                type: string
                              access_key:
                                type: string
                              secret_key:
                                type: string
                              endpoint:
                                type: string
                            required:
                              - region
                              - access_key
                              - secret_key
                              - endpoint
                        required:
                          - awskms
                      - title: azurekeyvault
                        properties:
                          azurekeyvault:
                            properties:
                              vault_name:
                                type: string
                              tenant_id:
                                type: string
                              client_id:
                                type: string
                              client_secret:
                                type: string
                            required:
                              - vault_name
                              - tenant_id
                              - client_id
                              - client_secret
                        required:
                          - azurekeyvault
                  oidc:
                    additionalProperties: false
                    description: >-
                      Holds many parts used in different locations. Please see
                      keycloak, istio and oauth-proxy all consuming parts.
                    properties:
                      adminGroupID:
                        type: string
                      apiUrl:
                        pattern: >-
                          ^(https:\/\/)([\w\-])+\.{1}([a-zA-Z]{2,63})([\/\w-]*)*\/?\??([^#\n\r]*)?#?([^\n\r]*)$
                        type: string
                      authUrl:
                        pattern: >-
                          ^(https:\/\/)([\w\-])+\.{1}([a-zA-Z]{2,63})([\/\w-]*)*\/?\??([^#\n\r]*)?#?([^\n\r]*)$
                        type: string
                      clientID:
                        type: string
                      clientSecret:
                        type: string
                      issuer:
                        pattern: >-
                          ^(https:\/\/)([\w\-])+\.{1}([a-zA-Z]{2,63})([\/\w-]*)*\/?\??([^#\n\r]*)?#?([^\n\r]*)$
                        type: string
                      scope:
                        type: string
                      teamAdminGroupID:
                        type: string
                      tenantID:
                        type: string
                      tokenUrl:
                        pattern: >-
                          ^(https:\/\/)([\w\-])+\.{1}([a-zA-Z]{2,63})([\/\w-]*)*\/?\??([^#\n\r]*)?#?([^\n\r]*)$
                        type: string
                      usernameClaimMapper:
                        type: string
                        description: >-
                          Claim name used by Keycloak to identify incoming users
                          from identity provider
                      subClaimMapper:
                        type: string
                        description: >-
                          Select OIDC claim to be used as a unique user
                          identifier
                        default: sub
                  otomi:
                    additionalProperties: false
                    properties:
                      hasCloudLB:
                        default: false
                        description: >-
                          Set this to true when an external LB exists or needs
                          to be started (AWS ALB, Azure AppGW, Google Apigee).
                          This will then be configured through ingress
                          controllers. Expects existing LBs to terminate https.
                          Currently this is only working correctly for Azure,
                          and not for AWS and Google. AWS is close to
                          completion.
                        type: boolean
                      isHomeMonitored:
                        default: false
                        description: >-
                          Whether this cluster is home monitored (like when
                          under a Premium SLA). Sends criticals home.
                        type: boolean
                      isManaged:
                        default: true
                        description: >-
                          Whether masters are managed and not under control. Set
                          this to false when onprem.
                        type: boolean
                      isMultitenant:
                        default: true
                        description: >-
                          Whether to separate team metrics and logs. Disabling
                          this lets everybody be admin and see everything.
                        type: boolean
                      mode:
                        default: ee
                        description: >-
                          The otomi-core edition. Either community edition (ce)
                          or enterprise edition (ee).
                        enum:
                          - ce
                          - ee
                        type: string
                      pullSecret:
                        default: ''
                        description: >-
                          The pullsecret to deploy the Otomi API and Console.
                          Requires an Otomi license.
                        type: string
                      teamPrefix:
                        default: team-
                        description: The prefix to use in URLs for team domains.
                        pattern: '^[a-z]+[-]{1}$'
                        type: string
                      addons:
                        description: Manage addon configuration
                        additionalProperties: false
                        properties:
                          conftest:
                            properties:
                              enabled:
                                type: boolean
                                default: true
                                description: >-
                                  Use this flag to enable conftest for policy
                                  validation
                  smtp:
                    additionalProperties: false
                    properties:
                      auth_identity:
                        type: string
                      auth_password:
                        type: string
                      auth_secret:
                        type: string
                      auth_username:
                        type: string
                      from:
                        description: The "from" address. Defaults to alerts@$clusterDomain.
                        pattern: >-
                          ^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$
                        type: string
                      hello:
                        type: string
                      smarthost:
                        description: 'The smtp host:port combination.'
                        pattern: >-
                          ^(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9]):()([1-9]|[1-5]?[0-9]{2,4}|6[1-4][0-9]{3}|65[1-4][0-9]{2}|655[1-2][0-9]|6553[1-5])$
                        type: string
                    required:
                      - smarthost
    put:
      operationId: editSettings
      description: Edits the settings from the `settings.yaml` file
      x-aclSchema: Settings
      requestBody:
        content:
          application/json:
            schema:
              x-acl: *ref_30
              additionalProperties: false
              properties: *ref_31
        description: Settings object that contains updated values
        required: true
      responses:
        '200':
          description: Successfully edited `settings.yaml`
        '400': *ref_12
        '404': *ref_13
servers:
  - url: /v1
components:
  parameters:
    teamParams:
      name: teamId
      in: path
      description: ID of team to return
      required: true
      schema: *ref_14
    serviceParams:
      name: serviceId
      in: path
      description: ID of the service
      required: true
      schema: *ref_32
    secretParams:
      name: secretId
      in: path
      description: ID of the secret
      required: true
      schema: *ref_33
  securitySchemes:
    groupAuthn:
      type: apiKey
      name: Authorization
      in: header
    groupAuthz:
      type: apiKey
      name: Authorization
      in: header
  schemas:
    Cloud:
      x-acl: &ref_47
        admin:
          - read-any
        team:
          - read-any
      properties: &ref_48
        name:
          type: string
          description: A cluster name
          readOnly: true
        clusters:
          type: array
          items:
            x-acl: *ref_34
            properties: *ref_35
        domain:
          type: string
          description: A fqdn for the cloud
    Cluster:
      x-acl: *ref_34
      properties: *ref_35
    Clusters:
      items: *ref_36
      type: array
      x-acl: *ref_37
    Deployment:
      x-externalDocsPath: docs/deployment
      x-acl: &ref_49
        admin:
          - read-any
        team:
          - read-any
      properties: &ref_50
        id:
          type: integer
        status:
          type: string
          readOnly: true
          description: Deployment status
          enum:
            - in-progress
            - completed
            - failed
    Kubecfg:
      x-acl: &ref_51
        admin:
          - read-any
        team:
          - read
      properties: &ref_52 {}
    OpenApiValidationError:
      x-acl: *ref_22
      properties: *ref_23
    OtomiStackError:
      x-acl: *ref_0
      properties: *ref_1
    Secret:
      x-acl: *ref_24
      properties: *ref_25
      required: *ref_26
      oneOf: *ref_27
    Secrets:
      items: *ref_20
      type: array
      x-acl: *ref_21
    Service:
      x-externalDocsPath: docs/configuring-services
      x-acl: *ref_17
      properties: *ref_18
      required: *ref_19
    Services:
      items: *ref_15
      type: array
      x-acl: *ref_16
    Session:
      x-acl: *ref_38
      properties: *ref_39
    Settings:
      x-acl: *ref_30
      additionalProperties: false
      properties: *ref_31
    Team:
      x-externalDocsPath: docs/configuring-teams
      x-acl: *ref_7
      properties: *ref_8
      required: *ref_9
    Teams:
      items: *ref_40
      type: array
      x-acl: *ref_41
    User:
      readOnly: true
      x-acl: *ref_42
      properties: *ref_43
      required: *ref_44
    cluster_Cluster:
      x-acl: *ref_34
      properties: *ref_35
    clusters_Clusters:
      items: *ref_36
      type: array
      x-acl: *ref_37
    secret_Secret:
      x-acl: *ref_24
      properties: *ref_25
      required: *ref_26
      oneOf: *ref_27
    secrets_Secrets:
      items: *ref_20
      type: array
      x-acl: *ref_21
    error_OpenApiValidationError:
      x-acl: *ref_22
      properties: *ref_23
    idName:
      description: A lowercase name that starts with a letter and may contain dashes.
      pattern: '^[a-z0-9]([-a-z0-9]*[a-z0-9])?$'
      type: string
    repository:
      description: A container image repository.
      pattern: '^[a-z0-9]+(?:[/._-]{1,2}[a-z0-9]+)*$'
      type: string
    env:
      additionalProperties: false
      nullable: true
      x-patternProperties: *ref_45
      title: Environment variables
    cpuQuantity:
      description: 'Amount of cores, or slice of cpu in millis.'
      example: *ref_5
      pattern: '^([0-9]+\.[0-9]{1,2})|([0-9]{2,3}m)?$'
      type: string
    memoryQuantity:
      description: Amount of memory. Valid units are E|P|T|G|M|K|Ei|Pi|Ti|Gi|Mi|Ki.
      example: *ref_6
      pattern: '^([0-9]+\.)?[0-9]+(E|P|T|G|M|K|Ei|Pi|Ti|Gi|Mi|Ki)?$'
      type: string
    labelsAnnotations:
      additionalProperties: false
      x-patternProperties: *ref_46
    domain:
      pattern: >-
        ^(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9])$
      type: string
    service_Service:
      x-externalDocsPath: docs/configuring-services
      x-acl: *ref_17
      properties: *ref_18
      required: *ref_19
    services_Services:
      items: *ref_15
      type: array
      x-acl: *ref_16
    azureMonitor:
      properties: *ref_28
    team_Team:
      x-externalDocsPath: docs/configuring-teams
      x-acl: *ref_7
      properties: *ref_8
      required: *ref_9
    teams_Teams:
      items: *ref_40
      type: array
      x-acl: *ref_41
    error_OtomiStackError:
      x-acl: *ref_0
      properties: *ref_1
    email:
      pattern: >-
        ^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$
      type: string
    user_User:
      readOnly: true
      x-acl: *ref_42
      properties: *ref_43
      required: *ref_44
    session_Session:
      x-acl: *ref_38
      properties: *ref_39
    url:
      pattern: >-
        ^(https:\/\/)([\w\-])+\.{1}([a-zA-Z]{2,63})([\/\w-]*)*\/?\??([^#\n\r]*)?#?([^\n\r]*)$
      type: string
    alerts:
      properties: *ref_29
    hostPort:
      pattern: >-
        ^(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9]):()([1-9]|[1-5]?[0-9]{2,4}|6[1-4][0-9]{3}|65[1-4][0-9]{2}|655[1-2][0-9]|6553[1-5])$
      type: string
    settings_Settings:
      x-acl: *ref_30
      additionalProperties: false
      properties: *ref_31
    cloud_Cloud:
      x-acl: *ref_47
      properties: *ref_48
    deployment_Deployment:
      x-externalDocsPath: docs/deployment
      x-acl: *ref_49
      properties: *ref_50
    kubecfg_Kubecfg:
      x-acl: *ref_51
      properties: *ref_52
