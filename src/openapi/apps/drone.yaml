AppDrone:
  additionalProperties: false
  x-externalDocsPath: https://drone.io
  x-short: Automate Software Build and Testing
  description: Drone is a self-service Continuous Integration platform for busy development teams.
  x-info: |
    Otomi uses Drone to deploy changes to the values repo. As such, it is installed and configured by default. When no source control is configured, Otomi will deploy Gitea as Drone's git hosting dependency.

    You may use Otomi's installment of Drone for other purposes if so desired, with the limitation that it can't be configured for multiple git repos.
  title: Drone
  type: object
  properties:
    id:
      $ref: ../definitions.yaml#/idName
    rawValues:
      $ref: ../definitions.yaml#/rawValues
    shortcuts:
      description: Resource URL that lands the user in a place of interest within an app.
      type: array
      nullable: true
      items:
        $ref: ../definitions.yaml#/shortcut
    values:
      x-externalDocsPath: docs/console/apps/drone
      additionalProperties: false
      type: object
      properties:
        adminUser:
          $ref: ../definitions.yaml#/wordCharacterPattern
          title: Admin username
          description: Username used to connect to remote git repo.
        adminToken:
          $ref: ../definitions.yaml#/wordCharacterPattern
          title: Admin token
          description: Token used by to connect to remote git repo.
          x-secret: ''
        debug:
          x-default: false
          type: boolean
          description: Turns on debugging
        trace:
          x-default: false
          type: boolean
          description: Turns on tracing
        orgsFilter:
          $ref: ../definitions.yaml#/wordCharacterPattern
          title: Organization filter
          description: A comma separated list of git organisations that drone will manage.
        repo:
          $ref: ../definitions.yaml#/idName
          description: A git repository
        repoFilter:
          $ref: ../definitions.yaml#/wordCharacterPattern
          description: A comma separated list of git repositories that drone will manage.
        sharedSecret:
          description: A secret used by drone-admit-members plugin. https://docs.drone.io/runner/kubernetes/configuration/reference/drone-secret-plugin-token/
          type: string
          x-secret: 'randAlphaNum 32'
        sourceControl:
          title: Source control
          description: Provide data to connect to a remote git host. When none is provided Otomi will deploy and configure an in-cluster Gitea repo.
          type: object
          oneOf:
            - $ref: ../definitions.yaml#/offChoice
            - title: Bitbucket Cloud
              type: object
              required: [bitbucketCloud]
              properties:
                provider:
                  default: bitbucketcloud
                  enum:
                    - bitbucketcloud
                  type: string
                bitbucketCloud:
                  title: Bitbucket Cloud
                  $ref: ../definitions.yaml#/droneGit
                  type: object
            - title: Bitbucket Server
              type: object
              required: [bitbucketServer]
              properties:
                provider:
                  default: bitbucketserver
                  enum:
                    - bitbucketserver
                  type: string
                bitbucketServer:
                  type: object
                  title: Bitbucket Server
                  properties:
                    consumerKey:
                      type: string
                      x-secret: ''
                    passwordKey:
                      type: string
                      x-secret: ''
                    privateKey:
                      type: string
                      x-secret: ''
                    server:
                      type: string
                    username:
                      type: string
                      x-secret: ''
            - title: Gitea
              type: object
              required: [gitea]
              properties:
                provider:
                  default: gitea
                  enum:
                    - gitea
                  type: string
                gitea:
                  title: Gitea
                  type: object
                  allOf:
                    - $ref: ../definitions.yaml#/droneGit
                    - properties:
                        server:
                          type: string
            - title: GitHub
              type: object
              required: [github]
              properties:
                provider:
                  default: github
                  enum:
                    - github
                  type: string
                github:
                  title: GitHub
                  type: object
                  allOf:
                    - $ref: ../definitions.yaml#/droneGit
                    - properties:
                        server:
                          type: string
                          x-default: https://github.com
            - title: GitLab
              type: object
              required: [gitlab]
              properties:
                provider:
                  default: gitlab
                  enum:
                    - gitlab
                  type: string
                gitlab:
                  title: GitLab
                  type: object
                  allOf:
                    - $ref: ../definitions.yaml#/droneGit
                    - properties:
                        server:
                          type: string
                          x-default: https://gitlab.com
            - title: Gogs
              type: object
              required: [gogs]
              properties:
                provider:
                  default: gogs
                  enum:
                    - gogs
                  type: string
                gogs:
                  title: Gogs
                  type: object
                  properties:
                    server:
                      type: string
        githubAdmins:
          additionalProperties: false
          title: Github admin group
          type: object
          description: '[GitHub only] The name of a github group given admin access in drone.'
          properties:
            org:
              $ref: ../definitions.yaml#/wordCharacterPattern
              title: Organization
              description: The name of the github organisation
            team:
              $ref: ../definitions.yaml#/wordCharacterPattern
              title: Team
              description: The name of the team
            token:
              $ref: ../definitions.yaml#/wordCharacterPattern
              title: Token
              description: The oauth secret used to identify with the github oauth app.
        image:
          type: object
          properties:
            agent:
              type: object
              properties:
                tag:
                  $ref: ../definitions.yaml#/imageTag
                  x-default: latest
                pullPolicy:
                  description: Container pull policy.
                  enum:
                    - IfNotPresent
                    - Always
                  type: string
                  default: Always
            server:
              type: object
              properties:
                tag:
                  $ref: ../definitions.yaml#/imageTag
                  x-default: 2.7.3
                pullPolicy:
                  $ref: ../definitions.yaml#/imagePullPolicy
        resources:
          type: object
          properties:
            runner:
              title: Runner
              type: object
              properties:
                requests:
                  type: object
                  properties:
                    cpu:
                      title: CPU quantity
                      description: Requested compute resources for all the containers started by the runner (guaranteed), expressed in millicores.
                      type: integer
                    memory:
                      $ref: ../definitions.yaml#/quantityMem
                      description: Requested memory resources for all the containers started by the runner (guaranteed).
              required:
                - requests
            agent:
              type: object
              properties:
                limits:
                  type: object
                  properties:
                    cpu:
                      $ref: ../definitions.yaml#/quantityCpu
                      x-default: 200m
                    memory:
                      $ref: ../definitions.yaml#/quantityMem
                      x-default: 256Mi
                requests:
                  type: object
                  properties:
                    cpu:
                      $ref: ../definitions.yaml#/quantityCpu
                      x-default: 40m
                    memory:
                      $ref: ../definitions.yaml#/quantityMem
                      x-default: 32Mi
              required:
                - limits
                - requests
            server:
              type: object
              properties:
                limits:
                  type: object
                  properties:
                    cpu:
                      $ref: ../definitions.yaml#/quantityCpu
                      x-default: 200m
                    memory:
                      $ref: ../definitions.yaml#/quantityMem
                      x-default: 256Mi
                requests:
                  type: object
                  properties:
                    cpu:
                      $ref: ../definitions.yaml#/quantityCpu
                      x-default: 40m
                    memory:
                      $ref: ../definitions.yaml#/quantityMem
                      x-default: 32Mi
              required:
                - limits
                - requests
