AppKeycloak:
  additionalProperties: false
  x-externalDocsPath: https://www.keycloak.org
  x-short: Open Source Identity and Access Management
  description: Add authentication to applications and secure services with minimum effort. No need to deal with storing users or authenticating users. Keycloak provides user federation, strong authentication, user management, fine-grained authorization, and more.
  x-info: |
    The SSO login page for Otomi is served by Keycloak. It is used as an identity broker or provider for all Otomi integrated applications. Keycloak is configured with mappers that normalize incoming identities from an IDP to have predictable claims format to be used by Otomi applications.

    Keycloak is automatically configured with 3 roles:

    - otomi-admin: super admin role for all platform configuration and core applications
    - team-admin: team admin role to manage teams and users
    - team: team role for team members

    And group (team) membership is reflected in the user's 'groups' claim.
    When this authorization configuration is useful to their own built applications, teams can directly use Keycloak's provided groups and roles claims. (There is no need for a client or token validation, as that has been done by the platform.) They can do so by turning on the "Authenticate with Single Sign On" checkbox. This then limits the application access to only allow the members of the team.

    When there are different requirements to use Keycloak for business applications, Keycloak's designated "master" and "otomi" realms may not be used, and an additional realm needs to be created. We refer to the keycloak docs for any custom configuration targeting business applications.
  title: Keycloak
  type: object
  properties:
    id:
      $ref: ../definitions.yaml#/idName
    rawValues:
      $ref: ../definitions.yaml#/rawValues
    shortcuts:
      description: Resource URL that lands the user in a place of interest within an app.
      type: array
      nullable: true
      items:
        $ref: ../definitions.yaml#/shortcut
    values:
      x-externalDocsPath: docs/console/apps/keycloak
      additionalProperties: false
      type: object
      properties:
        idp:
          additionalProperties: false
          type: object
          properties:
            alias:
              type: string
              x-default: otomi-idp
            clientID:
              $ref: ../definitions.yaml#/wordCharacterPattern
              x-default: otomi
            clientSecret:
              type: string
              x-secret: 'randAlphaNum 32'
        postgresqlPassword:
          type: string
          description: This password was generated and cannot be changed without manual intervention.
          x-secret: 'randAlphaNum 20'
          readOnly: true
        adminPassword:
          $ref: ../definitions.yaml#/adminPassword
        resources:
          additionalProperties: false
          type: object
          properties:
            keycloak:
              type: object
              properties:
                limits:
                  type: object
                  properties:
                    cpu:
                      $ref: ../definitions.yaml#/quantityCpu
                      x-default: '1'
                    memory:
                      $ref: ../definitions.yaml#/quantityMem
                      x-default: 1.5Gi
                requests:
                  type: object
                  properties:
                    cpu:
                      $ref: ../definitions.yaml#/quantityCpu
                      x-default: 100m
                    memory:
                      $ref: ../definitions.yaml#/quantityMem
                      x-default: 1Gi
              required:
                - limits
                - requests
            postgresql:
              type: object
              properties:
                limits:
                  type: object
                  properties:
                    cpu:
                      $ref: ../definitions.yaml#/quantityCpu
                      x-default: '1'
                    memory:
                      $ref: ../definitions.yaml#/quantityMem
                      x-default: 1.5Gi
                requests:
                  type: object
                  properties:
                    cpu:
                      $ref: ../definitions.yaml#/quantityCpu
                      x-default: 100m
                    memory:
                      $ref: ../definitions.yaml#/quantityMem
                      x-default: 1Gi
              required:
                - limits
                - requests
        ingressClassName:
          type: string
          x-default: platform
          description: Overwrite default ingress class if keycloak should be accessible under differrent IP address than the other platform applications.
      required:
        - postgresqlPassword
