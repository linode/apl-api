alerts:
  title: Alerts
  description: Configure alerting endpoints to receive notifications from Alertmanager and Otomi deployments.
  additionalProperties: false
  properties:
    repeatInterval:
      default: 3h
      description: Indicates waiting time before sending a notification again after it was sent successfully for an alert. (Usually ~3h or more).
      title: Repeat Interval
      type: string
    groupInterval:
      default: 5m
      description: How long to wait before sending a notification about new alerts that are added to a group of alerts for which an initial notification has already been sent. (Usually ~5m or more.)
      title: Group Interval
      type: string
    slack:
      title: Slack
      description: Configure Slack endpoints for alerts.
      additionalProperties: false
      properties:
        channel:
          default: mon-otomi
          description: The Slack channel for non-critical notifications.
          title: Non-critical
          type: string
        channelCrit:
          default: mon-otomi
          description: The Slack channel for critical notifications.
          title: Critical
          type: string
        url:
          $ref: '#/url'
          description: A Slack webhook URL.
      type: object
    email:
      title: Email
      description: Configure email endpoints for alerts.
      additionalProperties: false
      properties:
        critical:
          title: Critical Events
          $ref: '#/email'
          description: One or more email addresses (comma separated) for critical events.
        nonCritical:
          title: Non-critical Events
          $ref: '#/email'
          description: One or more email addresses (comma separated) for non-critical events.
      type: object
    msteams:
      additionalProperties: false
      description: Configure Microsoft Teams endpoints for alerts.
      properties:
        highPrio:
          title: High prio web hook
          type: string
        lowPrio:
          title: Low prio web hook
          type: string
      title: Microsoft Teams
      type: object
    receivers:
      description: Select default notification channel for receiving alerts.
      items:
        enum:
          - slack
          - msteams
          - email
        type: string
      title: Notification receivers
      type: array
      uniqueItems: true
    drone:
      default: slack
      description: Select default notification channel for Otomi deployments in Drone.
      enum:
        - slack
        - msteams
      title: Drone notifications
      type: string
annotation:
  type: string
  pattern: ^((.){1,253}\/)?(.){1,63}$
annotations:
  description: Kubernetes annotations with arbitrary metadata
  type: array
  items:
    type: object
    properties:
      name:
        $ref: '#/annotation'
      value:
        type: string
        maxLength: 32767
awsCreds:
  title: AWS credentials
  description: Amazon Web Services credentials.
  properties:
    accessKey:
      title: Access Key
      type: string
    secretKey:
      title: Secret Key
      type: string
    region:
      title: Region
      type: string
  type: object
  required:
    - accessKey
    - secretKey
    - region
azureCreds:
  title: Azure credentials
  description: Microsoft's Azure credentials.
  properties:
    clientId:
      description: Enter client ID.
      title: Client ID
      type: string
    clientSecret:
      description: Enter client secret.
      title: Client Secret
      type: string
    environment:
      description: Enter Azure environment.
      title: Environment
      type: string
    tenantId:
      description: Enter tenant ID.
      title: Tenant ID
      type: string
  type: object
  required:
    - clientId
    - clientSecret
    - tenantId
azureMonitor:
  description: Azure Monitor data can be made available in Grafana.
  title: Azure Monitor
  nullable: true
  oneOf:
    - $ref: '#/offChoice'
    - properties:
        clientId:
          title: Azure client id
          description: An Azure client id.
          type: string
        clientSecret:
          title: Azure client secret
          description: An Azure client secret.
          type: string
        tenantId:
          title: LogAnalytics tenant id
          description: An Azure monitor log analytics workspace.
          type: string
        subscriptionId:
          title: Azure subscription id
          description: An Azure subscription id.
          type: string
        azureLogAnalyticsSameAs:
          title: LogAnalytics using same creds?
          type: boolean
          default: true
        logAnalyticsClientId:
          title: LogAnalytics client id
          description: An Azure client secret.
          type: string
        logAnalyticsClientSecret:
          title: LogAnalytics client secret
          description: An Azure client secret.
          type: string
        logAnalyticsTenantId:
          title: LogAnalytics tenant id
          description: An Azure tenant id.
          type: string
        logAnalyticsDefaultWorkspace:
          title: LogAnalytics workspace
          description: An Azure LogAnalytics workspace.
          type: string
        appInsightsApiKey:
          title: AppInsights api key
          description: An Azure AppInsights client secret.
          type: string
        appInsightsAppId:
          title: AppInsights app id
          description: An Azure AppInsights client id.
          type: string
      required:
        - clientId
        - clientSecret
      title: 'On'
      type: object
containerSpecNoSec:
  properties:
    image:
      $ref: '#/image'
    resources:
      $ref: '#/resources'
      title: Container resources
    env:
      $ref: '#/env'
    secrets:
      $ref: '#/secrets'
    secretMounts:
      $ref: '#/secretMounts'
    files:
      $ref: '#/files'
    command:
      type: string
      title: Command
      description: Override the entrypoint/command of the container.
    args:
      type: string
      title: Command arguments
      description: Override the arguments given to the entrypoint/command of the container.
  required:
    - image
    - resources
containerSpec:
  allOf:
    - properties:
        securityContext:
          $ref: '#/securityContext'
    - $ref: '#/containerSpecNoSec'
cpuQuantity:
  title: CPU quantity
  description: Amount of cores, or slice of cpu in millis.
  default: 50m
  example:
    - '1'
    - 200m
  pattern: ^([0-9]+\.[0-9]{1,2})|([0-9]{2,3}m)?$
  type: string
# _ because it creates a duplicate dns model for some reason
dns:
  title: DNS
  description: Domain name server settings.
  additionalProperties: false
  properties:
    zones:
      description: Extra dns zones that the cluster can administer (see dns). Team services can use this to publish their URLs on.
      items:
        type: string
        title: Zone
      title: Zones
      type: array
      uniqueItems: true
    provider:
      description: The DNS provider managing the domains.
      title: Provider
      oneOf:
        - title: AWS
          properties:
            aws:
              title: ''
              properties:
                region:
                  type: string
              required:
                - region
          required:
            - aws
        - title: Azure
          properties:
            azure:
              title: ''
              properties:
                cloud:
                  title: Cloud
                  type: string
                  description: Azure Cloud
                resourceGroup:
                  title: Resource group
                  type: string
                  description: Azure resource group
                hostedZoneName:
                  title: Hosted zone name
                  type: string
                tenantId:
                  title: Tenant ID
                  type: string
                  description: Azure tenant ID
                subscriptionId:
                  title: Subscription ID
                  type: string
                  description: Azure subscription ID
                aadClientId:
                  title: Client ID
                  type: string
                  description: Azure Application Client ID
                aadClientSecret:
                  title: Client secret
                  type: string
                  description: Azure Application Client Secret
                useManagedIdentityExtension:
                  title: Using managed identities?
                  type: boolean
                  description: If you use Azure MSI, this should be set to true
                  default: false
              required:
                - resourceGroup
                - aadClientId
                - aadClientSecret
          required:
            - azure
        - title: Google
          properties:
            google:
              title: ''
              properties:
                serviceAccountKey:
                  description: A service account key for managing a DNS zone.
                  type: string
                project:
                  type: string
              required:
                - serviceAccountKey
                - project
          required:
            - google
domain:
  pattern: ^(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9])$
  type: string
email:
  pattern: ^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$
  type: string
env:
  title: Environment variables
  description: Environment variables for containers.
  type: array
  nullable: true
  items:
    properties:
      name:
        type: string
        pattern: ^[a-zA-Z0-9_]*$
      value:
        type: string
        maxLength: 131072
    required:
      - name
      - value
    type: object
files:
  description: 'Entries of absolute path > content pairs. One caveat: content can be 131072 chars max.'
  title: Files
  type: array
  nullable: true
  items:
    properties:
      path:
        type: string
        pattern: ^\/([A-z0-9-_+]+\/).*$
      content:
        type: string
        maxLength: 131072
    required:
      - path
      - content
    type: object
googleCreds:
  title: Google credentials
  description: Google's GCP credentials.
  properties:
    accountJson:
      description: Enter GCP account JSON for authentication.
      title: Account JSON
      type: string
    project:
      description: Enter GCP project.
      title: GCP Project
      type: string
hostPort:
  pattern: ^(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9]):()([1-9]|[1-5]?[0-9]{2,4}|6[1-4][0-9]{3}|65[1-4][0-9]{2}|655[1-2][0-9]|6553[1-5])$
  type: string
idName:
  pattern: ^[a-z0-9]([-a-z0-9]*[a-z0-9])?$
  type: string
image:
  allOf:
    - properties:
        repository:
          description: A container image repository.
          pattern: ^[a-z0-9]+(?:[/._-]{1,2}[a-z0-9]+)*$
          type: string
      required:
        - repository
    - $ref: '#/imageSimple'
  title: Container image
  type: object
imageSimple:
  properties:
    tag:
      default: latest
      pattern: '[\w][\w.-]{0,127}'
      type: string
    pullPolicy:
      default: IfNotPresent
      enum:
        - IfNotPresent
        - Always
      type: string
  required:
    - tag
  type: object
  title: Container image
jobSpec:
  properties:
    type:
      default: Job
      enum:
        - Job
        - CronJob
      type: string
    name:
      $ref: '#/idName'
      title: Name
      description: A job name
      example: some-job
    enabled:
      default: true
      type: boolean
    runPolicy:
      default: OnSpecChange
      description: |
        If runPolicy is set to 'Always', the job controller will always be re-deployed after a successful deployment with Helm.
        If runPolicy is set to 'OnSpecChange', the job controller will only be re-deployed if one changes this specification.
      enum:
        - Always
        - OnSpecChange
      type: string
    schedule:
      default: 0 1 * * *
      description: Must give a cron-type expression if the job-type is 'cronjob' (job.type).
      type: string
    script:
      $ref: '#/script'
    ttlSecondsAfterFinished:
      default: 86400
      description: Time To Live after job is finished in seconds. Will be removed afterwards.
      title: TTL after finished
      type: integer
    init:
      type: array
      items:
        $ref: '#/containerSpec'
      title: Init containers
      description: May specify an array of init containers, allowing to do preparations like checking for conditions.
  required:
    - name
    - script
    - type
k8sVersion:
  default: '1.19'
  description: The cluster k8s version. Otomi supports 2 minor versions backwards from the suggested default.
  enum:
    - '1.17'
    - '1.18'
    - '1.19'
  type: string
kms:
  additionalProperties: false
  description: Holds KMS settings like credentials for retrieving encryption/decryption keys.
  title: KMS settings
  properties:
    sops:
      description: Encryption credentials for SOPS to encrypt the platform secrets.
      title: SOPS credentials
      oneOf:
        - $ref: definitions.yaml#/awsCreds
        - $ref: definitions.yaml#/azureCreds
        - $ref: definitions.yaml#/googleCreds
        - $ref: definitions.yaml#/vaultCreds
ksvcNew:
  description: Will create a new knative service from the input gathered here.
  title: New knative service
  allOf:
    - properties:
        annotations:
          $ref: '#/annotations'
          title: Pod annotations
      type: object
    - properties:
        securityContext:
          properties:
            runAsUser:
              $ref: '#/runAsUser'
            readOnlyRootFilesystem:
              description: Whether this container has a read-only root filesystem. Default is false.
              type: boolean
              default: false
      type: object
    - $ref: '#/containerSpecNoSec'
    - properties:
        serviceType:
          default: ksvc
          enum:
            - ksvc
          type: string
        scaleToZero:
          default: false
          description: Scales to zero after 60 seconds and needs approximately 8 seconds to start back up.
          title: Scale to zero
          type: boolean
        containerPort:
          $ref: '#/portNumber'
          description: Container port the knative pod will connect with. Leaving this empty will let knative infer the port from the container, which usually works, but might be problematic when the container does not specifically expose a port. (As is the case with nginx derived images!)
          title: Container port
        autoCD:
          description: Deploys new images based on a tagging strategy
          oneOf:
            - $ref: '#/offChoice'
            - nullable: true
              properties:
                semver:
                  description: 'Use this filter if your image tags follow semantic versioning rules (MAJOR.MINOR.PATCH). E.g.: PATCH only: "~1.1", MINOR and PATCH only "~1", ALL "*"'
                  example: 'PATCH only: "~1.1", MINOR and PATCH only "~1", ALL "*",  ">=1.2.3-0"'
                  title: Semver version pattern
                  type: string
                tagMatcher:
                  default: semver
                  enum:
                    - semver
                  type: string
              required:
                - semver
              title: Semver versioning
              type: object
            - properties:
                glob:
                  description: 'Use this filter if you want to make glob-style patterns. E.g.: "main-v1.3.*"'
                  example: main-v1.3.*
                  title: Glob string pattern
                  type: string
                tagMatcher:
                  default: glob
                  enum:
                    - glob
                  type: string
              required:
                - glob
              title: Glob pattern matching
              type: object
              additionalProperties: false
          title: Continuous delivery (coming soon!)
          type: object
      required:
        - serviceType
      title: Knative service
      type: object
  x-externalDocsPath: docs/console/services/#1-new-knative-service
ksvcPredeployed:
  description: Will map onto a predeployed knative service. Will take care of rewriting to the existing knative url.
  properties:
    serviceType:
      default: ksvcPredeployed
      enum:
        - ksvcPredeployed
      type: string
  title: Existing Knative service
  type: object
labels:
  $ref: '#/annotations'
  description: A set of labels.
labelsAnnotations:
  additionalProperties: false
  items:
    properties:
      name:
        type: string
        pattern: ^((([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9]){1,253}\/)?([a-z0-9A-Z]+[a-z0-9A-Z-_.]+[a-z0-9A-Z]){1,63}$
      values:
        type: string
        pattern: ^((.){1,253}\/)?(.){1,63}$
    type: object
  type: array
logLevel:
  default: info
  enum:
    - error
    - warn
    - info
    - debug
    - trace
  type: string
memoryQuantity:
  title: Memory quantity
  description: Amount of memory. Valid units are E|P|T|G|M|K|Ei|Pi|Ti|Gi|Mi|Ki.
  default: 64Mi
  example:
    - 1Mi
    - 0.5M
  pattern: ^([0-9]+\.)?[0-9]+(E|P|T|G|M|K|Ei|Pi|Ti|Gi|Mi|Ki)?$
  type: string
offChoice:
  additionalProperties: false
  nullable: true
  title: 'Off'
  type: object
path:
  description: An absolute path
  type: string
  pattern: '^[/].*$'
podSecurityContext:
  properties:
    runAsUser:
      $ref: '#/runAsUser'
      description: The UID to run the entrypoint of the container process. Defaults to user specified in image metadata if unspecified. May also be set in PodSecurityContext. If set in both SecurityContext and PodSecurityContext, the value specified in SecurityContext takes precedence.
    runAsGroup:
      $ref: '#/runAsGroup'
      description: The GID to run the entrypoint of the container process. Defaults to group specified in image metadata if unspecified. May also be set in PodSecurityContext.  If set in both SecurityContext and PodSecurityContext, the value specified in SecurityContext takes precedence.
    runAsNonRoot:
      $ref: '#/runAsNonRoot'
      description: Will prevent any container from starting with UID 0.
    fsGroup:
      description: Supplementary group ID. Volumes that support ownership management are modified to be owned and writable by this ID.
      type: string
    fsGroupChangePolicy:
      description:
        'Defines behavior for changing ownership and permission of the volume before being exposed inside a Pod. This field only applies to volume types that support fsGroup controlled ownership and permissions.
        This field has two possible values:
        OnRootMismatch: Only change permissions and ownership if permission and ownership of root directory does not match with expected permissions of the volume. This could help shorten the time it takes to change ownership and permission of a volume.
        Always: Always change permission and ownership of the volume when volume is mounted.'
      enum:
        # - null
        - Always
        - OnRootMismatch
  description: Security context for the pod.
  title: Pod security context
podSpec:
  allOf:
    - properties:
        annotations:
          $ref: '#/annotations'
          title: Pod annotations
    - properties:
        podSecurityContext:
          $ref: '#/podSecurityContext'
    - $ref: '#/containerSpec'
  type: object
portNumber:
  maximum: 32768
  minimum: 80
  type: integer
rawValues:
  description: "May define value overrides for a chart. WARNING: these values currently have no schema and can't be validated as such, and may break deployment. You are on your own here."
  type: object
registry:
  pattern: ^[a-z0-9]+(?:[._-][a-z0-9]+)*$
  type: string
repoUrl:
  description: Path to a remote git repo without protocol. Will use https to access.
  pattern: ^(.+@)*([\w\d\.]+)(:[\d]+){0,1}/*(.*)$
  type: string
resource:
  properties:
    cpu:
      $ref: '#/cpuQuantity'
    memory:
      $ref: '#/memoryQuantity'
  required:
    - cpu
    - memory
  type: object
resources:
  description: Compute resources for containers.
  properties:
    limits:
      $ref: '#/resource'
      description: Requested resources (best effort).
    requests:
      $ref: '#/resource'
      description: Requested resources (guaranteed).
  title: Resources
  type: object
resourceQuota:
  description: 'List of kubernetes resource quota. Should adhere to the "spec.hard" format as described here: https://kubernetes.io/docs/concepts/policy/resource-quotas/. Not validated as there is no schema published. Change at your own risk.'
  title: Resource quota
  type: array
  items:
    type: object
    properties:
      name:
        type: string
      value:
        type: string
    required:
      - name
      - value
runAsUser:
  description: The UID to run the entrypoint of the container process. Defaults to user specified in image metadata if unspecified.
  default: 1001
  maximum: 65535
  minimum: 0
  title: Run as user
  type: integer
runAsGroup:
  description: The GID to run the entrypoint of the container process. Defaults to group specified in image metadata if unspecified.
  default: 1001
  maximum: 65535
  minimum: 0
  title: Run as group
  type: integer
runAsNonRoot:
  description: Will prevent the container from starting with UID 0.
  default: true
  title: Run as non-root
  type: boolean
scaling:
  description: Min and max number of replicas.
  properties:
    maxReplicas:
      type: integer
    minReplicas:
      type: integer
  type: object
script:
  description: May specify a non-empty string containing an executable script.
  type: string
securityContext:
  additionalProperties:
    uniqueItems: true
  properties:
    runAsUser:
      $ref: '#/runAsUser'
    runAsGroup:
      $ref: '#/runAsGroup'
    runAsNonRoot:
      $ref: '#/runAsNonRoot'
  type: object
secrets:
  description: A list of team secrets that will be mounted into the pod as env vars.
  items:
    type: string
  title: Secrets
  type: array
  uniqueItems: true
secretMounts:
  description: Pairs of secret name > absolute folder path. Will mount the contents of the secret in the container at the specified folder path.
  title: Secret mounts
  type: array
  items:
    properties:
      name:
        $ref: '#/idName'
      path:
        $ref: '#/path'
    type: object
subdomainType:
  pattern: ^[a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*$
  type: string
svcPredeployed:
  description: Will map onto a predeployed k8s service.
  properties:
    serviceType:
      default: svcPredeployed
      enum:
        - svcPredeployed
      type: string
  title: Existing Kubernetes service
  type: object
url:
  pattern: ^(https:\/\/)([\w\-])+\.{1}([a-zA-Z]{2,63})([\/\w-]*)*\/?\??([^#\n\r]*)?#?([^\n\r]*)$
  type: string
vaultCreds:
  title: Vault credentials
  description: Hashicorp's Vault credentials.
  properties:
    token:
      title: Token
      type: string
  required:
    - token
volumes:
  items:
    additionalProperties: false
    properties:
      configMap:
        properties:
          name:
            type: string
        type: object
      name:
        description: Name must match mount name.
        type: string
    type: object
  type: array
