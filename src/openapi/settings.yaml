url: &url
  pattern: ^(https:\/\/)([\w\-])+\.{1}([a-zA-Z]{2,63})([\/\w-]*)*\/?\??([^#\n\r]*)?#?([^\n\r]*)$
  type: string

alerts: &alerts
  type: object
  properties:
    drone:
      default: slack
      enum:
        - slack
        - msteams
      type: string
    email:
      additionalProperties: false
      properties:
        critical:
          $ref: 'definitions.yaml#/email'
          description: One or more email addresses (comma separated) for critical events.
        nonCritical:
          $ref: 'definitions.yaml#/email'
          description: One or more email addresses (comma separated) for non-critical events.
      type: object
    groupInterval:
      default: 5m
      description: How long to wait before sending a notification about new alerts that are added to a group of alerts for which an initial notification has already been sent. (Usually ~5m or more.)
      type: string
msteams:
  additionalProperties: false
  properties:
    highPrio:
      description: The low prio web hook.
      type: string
    lowPrio:
      description: The high prio web hook.
      type: string
  type: object
receivers:
  description: Notification receivers.
  items:
    enum:
      - slack
      - msteams
      - email
    type: string
  type: array
repeatInterval:
  default: 3h
  description: How long to wait before sending a notification again if it has already been sent successfully for an alert. (Usually ~3h or more).
  type: string
slack:
  additionalProperties: false
  properties:
    channel:
      default: mon-otomi
      description: The Slack channel for non-critical notifications.
      type: string
    channelCrit:
      default: mon-otomi
      description: The Slack channel for critical notifications.
      type: string
    url:
      <<: *url
      description: A Slack webhook URL.
  type: object

Settings:
  x-acl:
    admin: [read-any, update-any]
    team: []
  additionalProperties: false
  properties:
    alerts:
      <<: *alerts
    azure:
      description: Azure specific configuration.
      properties:
        appgw:
          properties:
            isManaged:
              default: true
              description: Is this appgw installed as AKS addon?
              type: boolean
          type: object
        monitor:
          $ref: definitions.yaml#/azureMonitor
        resourceGroup:
          description: An Azure resource group.
          type: string
        subscriptionId:
          description: An Azure subscription ID.
          type: string
        tenantId:
          description: An Azure tenant ID.
          type: string
      required:
        - resourceGroup
        - subscriptionId
        - tenantId
      type: object
    customer:
      additionalProperties: false
      properties:
        name:
          type: string
      type: object
    dns:
      properties:
        zones:
          description: Extra dns zones that the cluster can administer (see dns). Team services can use this to publish their URLs on.
          items:
            type: string
          type: array
        domain:
          type: string
          description: A fqdn for the cluster
      oneOf:
        - title: aws
          properties:
            aws:
              properties:
                region:
                  type: string
              required:
                - region
              type: object
          type: object
          required:
            - aws
        - title: azure
          properties:
            azure:
              properties:
                cloud:
                  title: Cloud
                  type: string
                  description: Azure Cloud
                resourceGroup:
                  title: Resource group
                  type: string
                  description: Azure resource group
                hostedZoneName:
                  title: Hosted zone name
                  type: string
                tenantId:
                  title: Tenant ID
                  type: string
                  description: Azure tenant ID
                subscriptionId:
                  title: Subscription ID
                  type: string
                  description: Azure subscription ID
                aadClientId:
                  title: Client ID
                  type: string
                  description: Azure Application Client ID
                aadClientSecret:
                  title: Client secret
                  type: string
                  description: Azure Application Client Secret
                useManagedIdentityExtension:
                  title: Using managed identities?
                  type: boolean
                  description: If you use Azure MSI, this should be set to true
                  default: false
              required:
                - resourceGroup
                - tenantId
                - subscriptionId
                - aadClientId
                - aadClientSecret
              type: object
          type: object
          required:
            - azure
        - title: google
          properties:
            google:
              properties:
                serviceAccountKey:
                  description: A service account key for managing a DNS zone.
                  type: string
                project:
                  type: string
              required:
                - serviceAccountKey
                - project
              type: object
          type: object
          required:
            - google
      required:
        - domain
      type: object
    kms:
      additionalProperties: false
      properties:
        sops:
          oneOf:
            - $ref: definitions.yaml#/awsCreds
            - $ref: definitions.yaml#/azureCreds
            - $ref: definitions.yaml#/googleCreds
            - $ref: definitions.yaml#/vaultCreds
    home:
      <<: *alerts
    oidc:
      additionalProperties: false
      description: 'Holds many parts used in different locations. Please see keycloak, istio and oauth-proxy all consuming parts.'
      properties:
        adminGroupID:
          type: string
        apiUrl:
          <<: *url
        authUrl:
          <<: *url
        clientID:
          type: string
        clientSecret:
          type: string
        issuer:
          <<: *url
        scope:
          type: string
        teamAdminGroupID:
          type: string
        tenantID:
          type: string
        tokenUrl:
          <<: *url
        usernameClaimMapper:
          type: string
          description: Claim name used by Keycloak to identify incoming users from identity provider
        subClaimMapper:
          type: string
          description: Select OIDC claim to be used as a unique user identifier
          default: sub
      type: object
    otomi:
      additionalProperties: false
      properties:
        hasCloudLB:
          default: false
          description: Set this to true when an external LB exists or needs to be started (AWS ALB, Azure AppGW, Google Apigee). This will then be configured through ingress controllers. Expects existing LBs to terminate https. Currently this is only working correctly for Azure, and not for AWS and Google. AWS is close to completion.
          type: boolean
        isHomeMonitored:
          default: false
          description: Whether this cluster is home monitored (like when under a Premium SLA). Sends criticals home.
          type: boolean
        isManaged:
          default: true
          description: Whether masters are managed and not under control. Set this to false when onprem.
          type: boolean
        isMultitenant:
          default: true
          description: Whether to separate team metrics and logs. Disabling this lets everybody be admin and see everything.
          type: boolean
        mode:
          default: ee
          description: The otomi-core edition. Either community edition (ce) or enterprise edition (ee).
          enum:
            - ce
            - ee
          type: string
        pullSecret:
          default: ''
          description: The pullsecret to deploy the Otomi API and Console. Requires an Otomi license.
          type: string
        teamPrefix:
          default: team-
          description: The prefix to use in URLs for team domains.
          pattern: ^[a-z]+[-]{1}$
          type: string
        addons:
          description: Manage addon configuration
          additionalProperties: false
          properties:
            conftest:
              properties:
                enabled:
                  type: boolean
                  default: true
                  description: Use this flag to enable conftest for policy validation
              type: object
          type: object
      type: object
    otomiInstanceUrls:
      description: Use this property to indicate other otomi instances and easily navigate between them from otomi-console
      type: array
      items:
        type: string
      default: []
    smtp:
      additionalProperties: false
      properties:
        auth_identity:
          type: string
        auth_password:
          type: string
        auth_secret:
          type: string
        auth_username:
          type: string
        from:
          $ref: definitions.yaml#/email
          description: The "from" address. Defaults to alerts@$clusterDomain.
        hello:
          type: string
        smarthost:
          $ref: definitions.yaml#/hostPort
          description: The smtp host:port combination.
      required:
        - smarthost
      type: object
  type: object
